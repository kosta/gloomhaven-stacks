<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Gloomhaven Stacks</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      // from https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array#2450976
      function shuffle(array) {
          for (var i = array.length - 1; i > 0; i--) {
              var j = Math.floor(Math.random() * (i + 1));
              var temp = array[i];
              array[i] = array[j];
              array[j] = temp;
          }
          return array;
      }

      class Pop extends React.Component {
        constructor(props) {
          super(props);
          this.clicked = this.clicked.bind(this);
        }

        clicked() {
          console.log("clicked ", this.props.name)
        }
        render() {
          return <button type="button" onClick={this.clicked}>{"Draw " + this.props.name + " Event"}</button>
        }
      }

      class ImportExport extends React.Component {
        constructor(props) {
          super(props);
          this.importClicked = this.importClicked.bind(this)
          this._textarea = null;
        }

        importClicked() {
          this.props.import(this._textarea.value)
        }

        render() {
          let that = this;
          return [
            <h2 key="h2">Import / Export</h2>,
            <textarea
              key="textarea" rows="20" cols="20"
              defaultValue={JSON.stringify(this.props.stacks, null, 2)}
              ref={(textarea) => {that._textarea = textarea; console.log("textarea", textarea, this)}}
            />,
            <button key="import" type="submit" onClick={this.importClicked}>{"Import"}</button>,
            <button key="cancel" type="submit" onClick={this.props.cancel}>{"Cancel"}</button>,
          ];
        }
      }

      class App extends React.Component {
        constructor(props) {
          super(props);

          this.showImportExport = this.showImportExport.bind(this);
          this.import = this.import.bind(this);
          this.cancel = this.cancel.bind(this);
          this.save = this.save.bind(this);

          this.state = {
            stacks: JSON.parse(window.localStorage.getItem("state")) || this.initialState(),
            dialog: null,
          };
          this.save();
        }

        initialState() {
          let thirty = [
             1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
            11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
            21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
            ];
          return {
            cityEvents: {
              stack: shuffle(thirty.slice(0)),
              history: [],
            },
            roadEvents: {
              stack: shuffle(thirty.slice(0)),
              history: [],
            }
          };
        }

        showImportExport() {
          console.log("state", this.state);
          let importExport = <ImportExport
              stacks={this.state.stacks}
              import={this.import}
              cancel={this.cancel}
              />;
          this.setState({
            dialog: importExport
            });
        }

        import(text) {
          try {
            let stacks = JSON.parse(text);
            this.setState({
              stacks: stacks,
              dialog: null,
            }, this.save);
          } catch(e) {
            //TODO :(
            alert(e.message)
          }
        }

        cancel() {
          this.setState({
            dialog: null
          })
        }

        save() {
          window.localStorage.setItem("state", JSON.stringify(this.state.stacks))
        }

        render() {
          return [
            <div key="button-frame" className="frame">
              <Pop key="city" name="City" events={this.state.stacks.cityEvents} />
              <Pop key="road" name="Road" events={this.state.stacks.roadEvents} />
              <button type="button" onClick={this.showImportExport}>Import / Export</button>
            </div>,
            <div key="dialog-frame" className="frame">
              {this.state.dialog}
            </div>
          ];
        }
      };

      let app = <App />;
      ReactDOM.render(
        app,
        document.getElementById('root')
      );

    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      But for this very small app it should be ok ;)

      To set up a production-ready React build environment, follow these instructions:
      * https://reactjs.org/docs/add-react-to-a-new-app.html
    -->
  </body>
</html>
